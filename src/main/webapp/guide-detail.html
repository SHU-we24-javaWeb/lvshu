<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>攻略详情 - 小绿书</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/bootstrap-icons.css" rel="stylesheet">
    <link href="css/tooplate-kool-form-pack.css" rel="stylesheet">
    <style>
        .menu-buttons {
            background-color: rgba(44, 44, 44, 0.9);
            padding: 20px 0;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .menu-btn {
            padding: 12px 30px;
            border-radius: 50px;
            background-color: transparent;
            color: #ffffff;
            border: 2px solid #ffffff;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .menu-btn:hover,
        .menu-btn.active {
            background-color: #ffffff;
            color: #000000;
            text-decoration: none;
        }

        .guide-detail {
            margin-top: 100px;
            padding: 40px 0;
            color: #ffffff;
        }

        .guide-header {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            margin-bottom: 30px;
        }

        .guide-content {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            margin-bottom: 30px;
        }

        .guide-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .guide-image {
            width: 100%;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .guide-image:hover {
            transform: scale(1.05);
        }

        .guide-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: rgba(255, 255, 255, 0.8);
        }

        .author-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .author-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.5);
        }

        .author-details {
            flex-grow: 1;
        }

        .author-name {
            margin: 0;
            font-weight: bold;
            color: #ffffff;
        }

        .author-signature {
            margin-top: 5px;
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.8);
        }

        .publish-time {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.6);
        }

        .video-wrap {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .custom-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .guide-actions {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .action-btn {
            background-color: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #ffffff;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .action-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .action-btn.active {
            background-color: #ffffff;
            color: #000000;
        }

        .action-btn i {
            font-size: 1.1em;
        }

        .comments-section {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            margin-top: 30px;
        }

        .comment-form-container {
            margin-bottom: 30px;
        }

        .comment-form-container textarea {
            background-color: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #ffffff;
            border-radius: 10px;
        }

        .comment-form-container textarea:focus {
            background-color: rgba(255, 255, 255, 0.3);
            border-color: #ffffff;
            color: #ffffff;
            box-shadow: none;
        }

        .comment-form-container button {
            background-color: transparent;
            border: 2px solid #ffffff;
            color: #ffffff;
            border-radius: 25px;
            padding: 8px 25px;
            transition: all 0.3s ease;
        }

        .comment-form-container button:hover {
            background-color: #ffffff;
            color: #000000;
        }

        .comment-item {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .comment-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .comment-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .comment-user-info {
            flex-grow: 1;
        }

        .comment-username {
            margin: 0;
            font-weight: bold;
            color: #ffffff;
        }

        .comment-time {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.6);
        }

        .comment-content {
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.5;
        }
    </style>
</head>

<body>
    <!-- 视频背景 -->
    <div class="video-wrap">
        <video autoplay loop muted class="custom-video">
            <source src="videos/video.mp4" type="video/mp4">
        </video>
    </div>

    <!-- 菜单栏 -->
    <div class="menu-buttons">
        <a href="home.html" class="menu-btn">
            <i class="bi bi-house-door"></i> 首页
        </a>
        <a href="search.html" class="menu-btn active">
            <i class="bi bi-search"></i> 搜索
        </a>
        <a href="create.html" class="menu-btn">
            <i class="bi bi-fire"></i> 创作
        </a>
        <a href="my.html" class="menu-btn">
            <i class="bi bi-person"></i> 我的
        </a>
    </div>


    <!-- 攻略详情内容 -->
    <div class="guide-detail">
        <div class="container">
            <div class="guide-header">
                <h1 id="guideTitle"></h1>
                <div class="guide-meta">
                    <span class="meta-item" id="guideLocation">
                        <i class="bi bi-geo-alt"></i>
                    </span>
                    <span class="meta-item" id="guideSeason">
                        <i class="bi bi-calendar"></i>
                    </span>
                    <span class="meta-item" id="guideCategory">
                        <i class="bi bi-tag"></i>
                    </span>
                    <span class="meta-item" id="guidePriceRange">
                        <i class="bi bi-currency-yen"></i>
                    </span>
                </div>
                <div class="author-info">
                    <img id="authorAvatar" src="" alt="作者头像" class="author-avatar">
                    <div class="author-details">
                        <h5 id="authorName" class="author-name mb-0"></h5>
                        <small id="publishTime" class="publish-time"></small>
                    </div>
                    <div class="guide-actions">
                        <form action="/lvshu/followServlet" method="post">
                            <input type="hidden" name="guideId" value="">
                            <button type="submit" id="followBtn" class="action-btn">
                                <i class="bi bi-person-plus"></i> 关注作者
                            </button>
                        </form>

                        <form action="/lvshu/favoriteServlet" method="post">
                            <input type="hidden" name="guideId" value="">
                            <button type="submit" id="favoriteBtn" class="action-btn">
                                <i class="bi bi-heart"></i> 收藏攻略
                            </button>
                        </form>

                        <button class="action-btn" onclick="shareGuide()">
                            <i class="bi bi-share"></i> 分享
                        </button>
                    </div>
                </div>
            </div>

            <div class="guide-content">
                <div id="guideContent"></div>
                <div id="guideImages" class="guide-images">
                    <!-- 图片将在这里动态显示 -->
                </div>
            </div>

            <!-- 在guide-content div后面添加评论区 -->
            <div class="comments-section">
                <!-- 评论表单 -->
                <div class="comment-form-container">
                    <h3 class="mb-4">发表评论</h3>
                    <form id="commentForm" action="/lvshu/CreateCommentServlet" method="post">
                        <input type="hidden" name="guideId" id="guideIdInput">
                        <div class="form-group">
                            <textarea class="form-control" name="comment" rows="3" 
                                      placeholder="写下你的想法..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">
                            <i class="bi bi-send"></i> 发表评论
                        </button>
                    </form>
                </div>

                <!-- 评论列表 -->
                <div class="comments-list mt-5">
                    <h3 class="mb-4">全部评论 <span id="commentCount" class="text-muted">(0)</span></h3>
                    <div id="commentsList">
                        <!-- 评论将通过JavaScript动态加载 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const guideId = urlParams.get('id');

            if (guideId) {
                loadGuideDetails(guideId);
            }
        });

        function loadGuideDetails(guideId) {
            fetch(`/lvshu/guide_details?id=${guideId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const guide = data.guide;

                        // 更新页面内容
                        document.getElementById('guideTitle').textContent = guide.title;
                        document.getElementById('guideLocation').innerHTML =
                            `<i class="bi bi-geo-alt"></i> ${guide.location || ''}`;
                        document.getElementById('guideSeason').innerHTML =
                            `<i class="bi bi-calendar"></i> ${guide.season || ''}`;
                        document.getElementById('guideCategory').innerHTML =
                            `<i class="bi bi-tag"></i> ${guide.category || ''}`;
                        document.getElementById('guidePriceRange').innerHTML =
                            `<i class="bi bi-currency-yen"></i> ${guide.priceRange || ''}`;

                        document.getElementById('guideContent').innerHTML =
                            formatContent(guide.content);

                        // 处理作者信息
                        if (guide.author) {
                            // 处理头像
                            const defaultAvatar = 'images/default-avatar.jpg';
                            const avatarUrl = guide.author.avatar ? guide.author.avatar : defaultAvatar;
                            const finalAvatarUrl = avatarUrl.startsWith('http') ? avatarUrl :
                                (avatarUrl.startsWith('/') ? '/lvshu' + avatarUrl : '/lvshu/' + avatarUrl);
                            document.getElementById('authorAvatar').src = finalAvatarUrl;

                            // 处理作者名和签名
                            document.getElementById('authorName').textContent = guide.author.username;
                            const signature = guide.author.signature ?
                                `<small class="text-muted d-block">${guide.author.signature}</small>` : '';
                            document.getElementById('authorName').insertAdjacentHTML('afterend', signature);

                            // 处理发布时间
                            const publishDate = guide.createdAt ? new Date(parseInt(guide.createdAt)) : new Date();
                            document.getElementById('publishTime').textContent = formatDate(publishDate);
                        } else {
                            // 如果没有作者信息，显示默认值
                            document.getElementById('authorAvatar').src = 'images/default-avatar.jpg';
                            document.getElementById('authorName').textContent = '未知作者';
                            document.getElementById('publishTime').textContent = '发布时间未知';
                        }

                        // 处理图片
                        if (guide.imagePaths) {
                            const images = guide.imagePaths.split(',');
                            const imagesHtml = images.map(img =>
                                `<img src="${img}" class="guide-image" onclick="showImage('${img}')">`
                            ).join('');
                            document.getElementById('guideImages').innerHTML = imagesHtml;
                        }

                        // 更新表单的action和隐藏字段
                        const followForm = document.querySelector('form[action^="/lvshu/followServlet"]');
                        followForm.action = `/lvshu/followServlet?id=${guide.guideId}`;

                        const favoriteForm = document.querySelector('form[action^="/lvshu/favoriteServlet"]');
                        favoriteForm.action = `/lvshu/favoriteServlet?id=${guide.guideId}`;
                        favoriteForm.querySelector('input[name="guideId"]').value = guide.guideId;

                        // 设置评论表单的guideId
                        document.getElementById('guideIdInput').value = guideId;
                        
                        // 加载评论
                        loadComments(guideId);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('guideContent').innerHTML =
                        `<div class="text-center">加载失败：${error.message}</div>`;
                });
        }

        function formatContent(content) {
            if (!content) return '';
            return content.replace(/\n/g, '<br>');
        }

        function formatDate(date) {
            if (!date) return '';
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            };
            return new Date(date).toLocaleString('zh-CN', options).replace(/\//g, '-');
        }

        function showImage(url) {
            window.open(url, '_blank');
        }

        let isFollowing = false;
        let isFavorited = false;

        function toggleFollow() {
            const followBtn = document.getElementById('followBtn');
            const authorId = guide.author.userId; // guide对象在加载详情时已获取

            fetch(`/lvshu/api/user/follow?authorId=${authorId}`, {
                method: 'POST',
                credentials: 'include'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        isFollowing = !isFollowing;
                        followBtn.classList.toggle('active');
                        followBtn.innerHTML = isFollowing ?
                            '<i class="bi bi-person-check"></i> 已关注' :
                            '<i class="bi bi-person-plus"></i> 关注作者';
                    } else {
                        alert(data.message || '操作失败，请稍后重试');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('操作失败，请稍后重试');
                });
        }

        function toggleFavorite() {
            const favoriteBtn = document.getElementById('favoriteBtn');
            const guideId = new URLSearchParams(window.location.search).get('id');

            fetch(`/lvshu/api/guide/favorite?guideId=${guideId}`, {
                method: 'POST',
                credentials: 'include'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        isFavorited = !isFavorited;
                        favoriteBtn.classList.toggle('active');
                        favoriteBtn.innerHTML = isFavorited ?
                            '<i class="bi bi-heart-fill"></i> 已收藏' :
                            '<i class="bi bi-heart"></i> 收藏攻略';
                    } else {
                        alert(data.message || '操作失败，请稍后重试');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('操作失败，请稍后重试');
                });
        }

        function shareGuide() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                alert('链接已复制到剪贴板');
            }).catch(err => {
                console.error('复制失败:', err);
                alert('复制失败，请手动复制链接');
            });
        }

        // 在加载攻略详情时检查关注和收藏状态
        function checkFollowStatus(authorId) {
            fetch(`/lvshu/api/user/follow/check?authorId=${authorId}`, {
                credentials: 'include'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        isFollowing = data.following;
                        const followBtn = document.getElementById('followBtn');
                        if (isFollowing) {
                            followBtn.classList.add('active');
                            followBtn.innerHTML = '<i class="bi bi-person-check"></i> 已关注';
                        }
                    }
                });
        }

        function checkFavoriteStatus(guideId) {
            fetch(`/lvshu/api/guide/favorite/check?guideId=${guideId}`, {
                credentials: 'include'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        isFavorited = data.favorited;
                        const favoriteBtn = document.getElementById('favoriteBtn');
                        if (isFavorited) {
                            favoriteBtn.classList.add('active');
                            favoriteBtn.innerHTML = '<i class="bi bi-heart-fill"></i> 已收藏';
                        }
                    }
                });
        }

        // 添加加载评论的函数
        function loadComments(guideId) {
            fetch(`/lvshu/ShowCommentServlet?guideId=${guideId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const commentsContainer = document.getElementById('commentsList');
                        document.getElementById('commentCount').textContent = 
                            `(${data.comments.length})`;
                        
                        commentsContainer.innerHTML = data.comments.map(comment => `
                            <div class="comment-item">
                                <div class="comment-header">
                                    <img src="${comment.user.avatar || 'images/default-avatar.jpg'}" 
                                         alt="用户头像" 
                                         class="comment-avatar">
                                    <div class="comment-user-info">
                                        <h5 class="comment-username">${escapeHtml(comment.user.username)}</h5>
                                        <span class="comment-time">${formatDate(comment.createdAt)}</span>
                                    </div>
                                </div>
                                <div class="comment-content">
                                    ${escapeHtml(comment.comment)}
                                </div>
                            </div>
                        `).join('');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('commentsList').innerHTML = 
                        '<div class="text-center">加载评论失败</div>';
                });
        }

        // // 处理评论表单提交
        // document.getElementById('commentForm').addEventListener('submit', function(e) {
        //     e.preventDefault();
        //
        //     const formData = new FormData(this);
        //
        //     fetch('/lvshu/CreateCommentServlet', {
        //         method: 'POST',
        //         body: formData
        //     })
        //     .then(response => response.json())
        //     .then(data => {
        //         if (data.success) {
        //             // 清空评论框
        //             this.reset();
        //             // 重新加载评论
        //             loadComments(formData.get('guideId'));
        //             alert('评论发表成功！');
        //         } else {
        //             alert(data.message || '评论发表失败');
        //         }
        //     })
        //     .catch(error => {
        //         console.error('Error:', error);
        //         alert('评论发表失败，请稍后重试');
        //     });
        // });
    </script>
</body>

</html>